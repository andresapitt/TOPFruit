var Alloy=require("alloy"),_=Alloy._,Backbone=Alloy.Backbone;Ti.API.info("in the alloy.js file"),Alloy.Globals.ContactEmail="theperfectmixidl@gmail.com",Alloy.Globals.BaseUrl="http://www.vocal.ie",Alloy.Globals.PrimaryColor="#313646",Alloy.Globals.FacebookColor="#3b5998",Alloy.Globals.MainFont="'HelveticaNeue-Thin'",Alloy.Globals.BoldFont="'HelveticaNeueLT-BoldCond'",Alloy.Globals.JamesonFontLight="'JJLt-Regular'",Alloy.Globals.JamesonFontBold="'JJBl-Regular'",Alloy.Globals.AbsolutFontLight="'Absolut Script'",Alloy.Globals.AbsolutFontBold="'Absolut Headline'",Alloy.Globals.MalibuFontLight="'MalibuSlab-300'",Alloy.Globals.MalibuFontBold="'MalibuBrushcript-Medium'",Alloy.Globals.MainFontSize="18dp";var json_data_cache_updates=new Array;json_data_cache_updates.push({file:"data/Tips.txt",elapsed_time:6e4}),json_data_cache_updates.push({file:"data/Events.txt",elapsed_time:6e4}),json_data_cache_updates.push({file:"data/Competitions.txt",elapsed_time:6e4}),json_data_cache_updates.push({file:"data/Cocktails.txt",elapsed_time:6e4}),json_data_cache_updates.push({file:"data/Drinks.txt",elapsed_time:6e4}),json_data_cache_updates.push({file:"data/FeaturedMix.txt",elapsed_time:6e4}),Alloy.Globals.windowStack=new Array,Ti.App.addEventListener("openWebURL",function(e){Ti.API.info("URL link to open: "+e.UrlToOpen),Ti.Platform.openURL(e.UrlToOpen)});var dir=Titanium.Filesystem.getFile(Titanium.Filesystem.applicationDataDirectory,"data");dir.createDirectory(),Alloy.Globals.Utils={_getExtension:function(e){var i=/(?:\.([^.]+))?$/,t=i.exec(e)[1];return t?t:""},RemoteImage:function(e){function i(e){n.removeEventListener("load",i),Ti.API.info("image link string (iPHONE): "+n.image);var t=Ti.Filesystem.getFile(Titanium.Filesystem.applicationCacheDirectory,e.source.md5);t.write(e.source.toBlob()),t=null}e=e||{};var t,a,l,o,s,n,n,n,r=!1;if(e.image){if(0!=e.checkRetina&&"high"==Ti.Platform.displayCaps.density){var l=e.image,o=l.replace(/\\/g,"/").replace(/.*\//,""),s=o.split(".");l=l.replace(o,s[0]+"@2x."+s[1]),Ti.API.info("full image path: "+l),e.image=l}t=Ti.Utils.md5HexDigest(e.image)+this._getExtension(e.image),Ti.API.info("MD% string return: "+t),a=Titanium.Filesystem.getFile(Titanium.Filesystem.applicationCacheDirectory,t),a.exists()?(Ti.API.info("Image file already cached"),e.image=a):(Ti.API.info("Image file needs to be downloaded"),r=!0),a=null}var n=Ti.UI.createImageView(e);return!0===r&&n.addEventListener("load",i),n.width=e.width,n.height=e.height,n.opacity=e.opacity,n.touchEnabled=e.touchEnabled,n},RetrieveJson:function(e,i,t){Ti.API.info("in json retrieve function, url: "+e);var a=Ti.Network.createHTTPClient();a.open("GET",Alloy.Globals.BaseUrl+e),a.onload=function(){Ti.API.info("Text Recieved"+this.responseText);var e=null;try{e=JSON.parse(this.responseText)}catch(a){Ti.API.info("Invalid JSON recieved - use last saved JSON or local stored ( "+i+" )")}if(null!=e){if(Ti.API.info("Valid JSON recieved ( "+i+" )"),null!=i&&""!=i){Ti.API.info("Save JSON File at: "+i);var l=Titanium.Filesystem.getFile(Ti.Filesystem.applicationDataDirectory,i);l.write(this.responseText);var o=Titanium.App.Properties.getList("JsonSaves",new Array);if(0==o.length)Ti.API.info("No saved Json Dates found, save file '"+i+"' at utc time: "+(new Date).getTime()),o.push({file:i,utc_date:(new Date).getTime()});else{for(var s=!1,n=0;o.length>n;n++)o[n].file==i&&(s=!0,o[n].utc_date=(new Date).getTime());s||o.push({file:i,utc_date:(new Date).getTime()})}Titanium.App.Properties.setList("JsonSaves",o)}null!=t&&t(this.responseText)}else{var r="",c=Titanium.Filesystem.getFile(Ti.Filesystem.applicationDataDirectory,i);if(c.exists())r=c.read(),t(r);else{var d=Titanium.Filesystem.getFile(Ti.Filesystem.resourcesDirectory,i);d.exists()&&(r=d.read(),t(r))}}},a.send()},GetAppData:function(e,i,t){var a=Titanium.Filesystem.getFile(Ti.Filesystem.applicationDataDirectory,i),l="",o=(new Date).getTime(),s=6e4;if(Ti.API.info("current UTC time is: "+o),a.exists())if(Titanium.Network.networkType!=Titanium.Network.NETWORK_NONE){for(var n=!1,r=Titanium.App.Properties.getList("JsonSaves",new Array),c=!1,d=0;r.length>d;d++)if(r[d].file==i){c=!0,Ti.API.info("match is true: "+r[d].file+", file path: "+i);var u=json_data_cache_updates.filter(function(e){return e.file==i});null!=u[0]&&(Ti.API.info("filter cache time update file: "+u[0].file+", time to update: "+u[0].elapsed_time),s=u[0].elapsed_time),(new Date).getTime()-r[d].utc_date>s&&(Ti.API.info("UTC Time has passed, update JSON from CMS"),n=!0,this.RetrieveJson(e,i,t))}c||(Ti.API.info("Match is false"),n=!0,this.RetrieveJson(e,i,t)),n||(Ti.API.info("To update is false"),l=a.read(),t(l))}else l=a.read(),t(l);else if(Titanium.Network.networkType!=Titanium.Network.NETWORK_NONE)Ti.API.info("No CMS file. Internet found. Get online file"),this.RetrieveJson(e,i,t);else{var p=Titanium.Filesystem.getFile(Ti.Filesystem.resourcesDirectory,i);p.exists()?(Ti.API.info("Json local text file exists: "+i),l=p.read(),t(l)):alert("Tips json local text file not found")}},updateCocktailRating:function(e,i){function t(t){for(var a=JSON.parse(t),l=0;a.length>l;l++)a[l].Cocktail.id==e&&(a[l].Cocktail.rating=i);var o=Titanium.Filesystem.getFile(Ti.Filesystem.applicationDataDirectory,"data/Cocktails.txt");o.write(JSON.stringify(a))}this.GetAppData(Alloy.Globals.BaseUrl+"/client/idl/perfect-mix/cocktails/cocktails/viewjson","data/Cocktails.txt",t)}},Alloy.Globals.goToHome=function(){Ti.API.info("Go to home function, window stack count: "+Alloy.Globals.windowStack.length);for(var e=Alloy.Globals.windowStack.length,i=0;e>i;i++)i==e-1?(Ti.API.info("Close index: (top window) "+i),Alloy.Globals.windowStack[0].close(),Alloy.Globals.windowStack.shift()):(Ti.API.info("Close index: "+i),Alloy.Globals.windowStack[0].close(),Alloy.Globals.windowStack.shift())},Ti.Gesture.addEventListener("shake",function(e){e.timestamp>2e3}),Alloy.createController("index");