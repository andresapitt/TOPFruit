define(["Ti/_/declare","Ti/_/dom","Ti/_/event","Ti/_/lang","Ti/App/Properties","Ti/Geolocation","Ti/Map","Ti/UI/View","Ti/Utils"],function(t,e,n,i,a,o,s,r,l){function u(t){var e=d.MapTypeId;switch(t){case s.HYBRID_TYPE:return e.HYBRID;case s.SATELLITE_TYPE:return e.SATELLITE;case s.TERRAIN_TYPE:return e.TERRAIN}return e.ROADMAP}var d,c,p,h,g=i.isDef,_=require.mix,m=require.on,f=r.prototype.fireEvent,v={latitude:39.828175,longitude:-98.5795,latitudeDelta:30.137412,longitudeDelta:63.235658},w={0:"red",1:"green",2:"purple"},M=Ti.deferStart(),T=t("Ti.Map.View",r,{constructor:function(){this.__values__.properties.annotations=[],this._annotationMap={},this._routes=[],this.fireEvent("loading")},postscript:function(){var t=this,e=t.region||v,n=t._gmap=new d.Map(t.domNode,{disableDefaultUI:!0,zoom:2,zoomControl:!0,center:new d.LatLng(e.latitude,e.longitude),mapTypeId:u(t.mapType)});m(t,"postlayout",function(){c.trigger(n,"resize"),t._updateMap(e,1),setTimeout(function(){t._updateMap(e,1),t._updateUserLocation(t.userLocation),t.annotations.forEach(t._createMarker,t),t._annotationEvents=[],t._boundsEvt=c.addListener(n,"bounds_changed",i.hitch(t,"_fitRegion"))},1)})},destroy:function(){n.off(this._annotationEvents),c.removeListener(this._boundsEvt),c.clearInstanceListeners(this._gmap),this.removeAllAnnotations(),this._gmap=null,r.prototype.destroy.apply(this,arguments)},addAnnotation:function(t){t&&("Ti.Map.Annotation"===t.declaredClass||(t=new Annotation(t)),~this.annotations.indexOf(t)||this._createMarker(t),t.title&&(this._annotationMap[t.title]=t))},addAnnotations:function(t){t&&t.forEach(this.addAnnotation,this)},addRoute:function(t){t&&(t.points||[]).length&&(t.pline=new d.Polyline({map:this._gmap,path:t.points.map(function(t){return new d.LatLng(t.latitude,t.longitude)}),strokeColor:t.color||"#000",strokeWeight:t.width||1}),this._routes.push(t))},deselectAnnotation:function(t){require.is(t,"String")&&(t=this._annotationMap[t]),t&&p&&p.widgetId===t.widgetId&&this._hide(t)},removeAllAnnotations:function(){for(p&&p.close();this.annotations.length;)this.removeAnnotation(this.annotations[0])},removeAnnotation:function(t){if(require.is(t,"String")&&(t=this._annotationMap[t]),t){var e=this.__values__.properties.annotations,n=e.indexOf(t);p&&this._hide(t),c.removeListener(t.evt),t.marker.setMap(null),delete t.marker,t.destroy(),~n&&e.splice(n,1)}},removeAnnotations:function(t){t.forEach(function(t){this.removeAnnotation(t)},this)},removeRoute:function(t){if(t&&t.name)for(var e=this._routes,n=0;n<e.length;n++)e[n].name===t.name&&(t.pline.setMap(null),delete t.pline,e.splice(n--,1))},selectAnnotation:function(t){require.is(t,"String")&&(t=this._annotationMap[t]),t&&this._show(t)},setLocation:function(t){t&&(this.region=t),g(t.animate)&&(this.animated=t.animate),g(t.animated)&&(this.animated=t.animated),g(t.regionFit)&&(this.regionFit=t.regionFit),this._updateMap(t)},zoom:function(t){var e=this._gmap;e.setZoom(e.getZoom()+t)},_show:function(t,i){function a(){s||(s=1)&&r._dispatchEvents(t,i)}if(t&&(!p||p.widgetId!==t.widgetId)){var o,s,r=this,l=t.widgetId,u="TiMapAnnotation",h=e.create("div",{className:u}),g=h,_={annotation:g,leftButton:t.leftButton&&e.create("img",{className:u+"LeftButton",src:t.leftButton},h),rightButton:t.rightButton&&e.create("img",{className:u+"RightButton",src:t.rightButton},h),dummy:(h=e.create("div",{className:u+"Content"},h))&&0,title:e.create("h1",{innerHTML:t._getTitle()},h),subtitle:e.create("p",{innerHTML:t._getSubtitle()},h)};n.off(r._annotationEvents);for(o in _)!function(e,i){i&&r._annotationEvents.push(m(i,"click",function(i){n.stop(i),r._hide(t,e)}))}(o,_[o]);r._annotationEvents.push(m(t,"update",this,function(e){if(p.widgetId===l){var n,i=e.property,a=e.value,o=this._annotationMap;switch(i){case"title":case"subtitle":_[i].innerHTML=a,delete o[e.oldValue],a&&(o[a]=t);break;case"leftButton":case"rightButton":_[i].src=a;break;case"image":case"pincolor":n=r._getMarkerImage(t),t.marker.setIcon(n[0]),t.marker.setShadow(n[1]||null)}}})),p?(a(),p.setContent(g)):(p=new d.InfoWindow({content:g}),c.addListener(p,"domready",a),c.addListener(p,"closeclick",function(){r._hide(t,"annotation")})),p.open(r._gmap,t.marker),p.widgetId=t.widgetId}},_hide:function(t,e){e&&~e.indexOf("Button")||(p.close(),p.widgetId=0),this._dispatchEvents(t,e)},_dispatchEvents:function(t,e){var n=this.annotations.indexOf(t),i={annotation:t,clicksource:e=e||"pin",index:n,latitude:t.latitude,longitude:t.longitude,map:this,subtitle:t._getSubtitle(),title:t._getTitle()};f.call(this,"singletap",i),f.call(this,"click",i),t._onclick(this,n,e)},_getMarkerImage:function(t){var e,n,i=w[0|t.pincolor];return t.image&&("Ti.Blob"===t.image.declaredClass?(i=w[e=l.md5HexDigest(n=t.image.toString())],i||(i=w[e]=[new d.MarkerImage(n)])):(i=w[t.image],i||(i=w[t.image]=[new d.MarkerImage(t.image)]))),i},_createMarker:function(t){var e=this._getMarkerImage(t);t.evt=c.addListener(t.marker=new d.Marker({map:this._gmap,icon:e[0],shadow:e[1],position:new d.LatLng(t.latitude,t.longitude),optimized:!1,title:t._getTitle(),animation:t.animate&&d.Animation.DROP}),"click",i.hitch(this,function(){this[p&&p.widgetId===t.widgetId?"_hide":"_show"](t)})),this.__values__.properties.annotations.push(t)},_fitRegion:function(){var t=this.__values__.constants,e=this._gmap,n=e.getCenter(),i=e.getBounds(),a=i.getNorthEast(),o=i.getSouthWest(),s=t.latitudeDelta=a.lat()-o.lat(),r=t.longitudeDelta=a.lng()-o.lng(),l={latitude:n.lat(),longitude:n.lng(),latitudeDelta:s,longitudeDelta:r};this.regionFit&&(this.__values__.properties.region=l),this._initialized||(this._initialized=1,this.fireEvent("complete")),this.fireEvent("regionchanged",l)},_updateMap:function(t,e){var n=this._gmap;if(n){var i=!e&&this.animated,a=t.latitudeDelta/2,o=t.longitudeDelta/2;n[i?"panTo":"setCenter"](new d.LatLng(t.latitude,t.longitude)),n[i?"panToBounds":"fitBounds"](new d.LatLngBounds(new d.LatLng(t.latitude-a,t.longitude-o),new d.LatLng(t.latitude+a,t.longitude+o)))}},_updateUserLocation:function(t){var e=this._gmap;e&&(t||this._locationInited)&&(this._locationInited=1,o[t?"addEventListener":"removeEventListener"]("location",i.hitch(this,function(t){var e,n=this._locationMarker,i=t.coords,a=t.code;i?(e=new d.LatLng(i.latitude,i.longitude),n?n.setPosition(e):this._locationMarker=new d.Marker({map:this._gmap,icon:h,position:e})):"code"in t&&Ti.API.warn("Geolocation error: "+(a===o.ERROR_DENIED?"permission denied":a===o.ERROR_TIMEOUT?"timeout":a===o.ERROR_LOCATION_UNKNOWN?"position unavailable":"unknown"))})),o.locationServicesEnabled?(!t||this._locationMarker)&&this._locationMarker.setVisible(t):(Ti.API.warn("Geolocation services unavailable"),this.__values__.properties.userLocation=!1))},fireEvent:function(t){/(click|singletap)/.test(t)||r.prototype.fireEvent.apply(this,arguments)},constants:{latitudeDelta:0,longitudeDelta:0},properties:{animated:!1,annotations:{set:function(t){return t=t.filter(function(t){return t&&"Ti.Map.Annotation"===t.declaredClass}),this._gmap&&(this.removeAllAnnotations(),t.forEach(this._createMarker,this)),t}},mapType:{set:function(t){return this._gmap&&this._gmap.setMapTypeId(u(t)),t}},region:{set:function(t,e){return _({},v,e,t)},post:function(t,e){t!==e&&this._updateMap(t)},value:null},regionFit:!0,userLocation:{post:function(t){this._updateUserLocation(t)},value:!1}}});return window.TiMapViewInit=function(){function t(t,e,a){return new d.MarkerImage(n+"marker_"+t+".png",new d.Size(e,34),new i(a,0),new i(10,34))}d=google.maps,c=d.event;var e,n="themes/"+require.config.ti.theme+"/Map/",i=d.Point;for(e in w)w[e]=[t(w[e],20,0),t(w[e],37,20)];h=new d.MarkerImage(n+"location.png",new d.Size(22,22),new i(0,0),new i(11,11)),M()},require(["//maps.googleapis.com/maps/api/js?key="+a.getString("ti.map.apikey","")+"&sensor=true&callback=TiMapViewInit"],0,M),T});