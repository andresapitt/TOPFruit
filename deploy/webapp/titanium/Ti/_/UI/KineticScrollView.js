define(["Ti/_/browser","Ti/_/declare","Ti/UI/View","Ti/_/lang","Ti/_/dom","Ti/_/style","Ti/UI","Ti/_/event"],function(t,a,i,r,n,e,o){var l=(e.set,n.unitize),s=n.calculateDistance,c=require.on,h=100,_=100;return a("Ti._.UI.KineticScrollView",i,{_initKineticScrollView:function(t,a,i,r){function n(){f=Date.now(),B=f-T,T=f,M++?(W=(W*(M-1)+M*(d-S)/B)/2/M,A=(A*(M-1)+M*(m-v)/B)/2/M):(W=(d-h)/B,A=(m-_)/B)}function e(){u=z._minTranslationX=Math.min(0,z._measuredWidth-z._borderLeftWidth-z._borderRightWidth-z._contentContainer._measuredWidth),g=z._minTranslationY=Math.min(0,z._measuredHeight-z._borderTopWidth-z._borderBottomWidth-z._contentContainer._measuredHeight)}var l,h,_,d,m,u,g,T,f,B,S,v,M,W,A,y,z=this;z._currentTranslationX=0,z._currentTranslationY=0,z._horizontalElastic="horizontal"===a||"both"===a,z._verticalElastic="vertical"===a||"both"===a,z._kineticTransform=o.create2DMatrix(),("horizontal"===i||"both"===i)&&z._createHorizontalScrollBar(),("vertical"===i||"both"===i)&&z._createVerticalScrollBar(),z._add(z._contentContainer=t),l=t.domNode,c(z._contentContainer,"postlayout",function(){e(),z._setTranslation(z._currentTranslationX,z._currentTranslationY)}),c(z,"draggingstart",function(a){if(z.scrollingEnabled){z._cancelAnimations(),W=void 0,A=void 0,h=z._currentTranslationX,_=z._currentTranslationY,M=0,T=(new Date).getTime(),e();var i=z._measuredWidth,r=z._measuredHeight,n=t._measuredWidth,o=t._measuredHeight;z._startScrollBars({x:-z._currentTranslationX/(n-i),y:-z._currentTranslationY/(o-r)},{x:i/n,y:r/o}),z._handleDragStart&&z._handleDragStart(a)}}),c(z,"dragging",function(t){z.scrollingEnabled&&(d=h+t.distanceX,m=_+t.distanceY,n(),z._setTranslation(S=d,v=m),z._handleDrag&&z._handleDrag(t))}),c(z,"draggingcancel",function(t){z.scrollingEnabled&&(z._animateToPosition(h,_,400+.3*s(h,_,z._currentTranslationX,z._currentTranslationY),o.ANIMATION_CURVE_EASE_IN_OUT,function(){z._handleDragCancel&&z._handleDragCancel(t)}),z._endScrollBars(),z._handleDragCancel&&z._handleDragCancel(t))}),c(z,"draggingend",function(t){if(z.scrollingEnabled){d=h+t.distanceX,m=_+t.distanceY,n();var a,i=z._currentTranslationX,r=z._currentTranslationY;i>0?(i=0,a=1):u>i&&(i=u,a=1),r>0?(r=0,a=1):g>r&&(r=g,a=1),a?z._animateToPosition(i,r,200,o.ANIMATION_CURVE_EASE_OUT,function(){z._handleDragEnd&&z._handleDragEnd(t),z._endScrollBars()}):z._handleDragEnd&&z._handleDragEnd(t,W,A)}}),r&&(this._disconnectMouseWheelEvent=c(z.domNode,"mousewheel",function(a){if(z.scrollingEnabled){z._cancelAnimations();var i=t._measuredWidth-z._measuredWidth,r=t._measuredHeight-z._measuredHeight,n=-z._currentTranslationX,o=-z._currentTranslationY;e(),z._startScrollBars({x:n/i,y:o/r},{x:z._measuredWidth/t._measuredWidth,y:z._measuredHeight/t._measuredHeight}),z._setTranslation(Math.min(0,Math.max(z._minTranslationX,-n+a.wheelDeltaX)),Math.min(0,Math.max(z._minTranslationY,-o+a.wheelDeltaY))),clearTimeout(y),y=setTimeout(function(){z._endScrollBars()},500),z._handleMouseWheel&&z._handleMouseWheel()}}))},destroy:function(){this._disconnectMouseWheelEvent&&this._disconnectMouseWheelEvent(),i.prototype.destroy.apply(this,arguments)},_animateToPosition:function(t,a,i,r,n){var e,o=this,l=o._contentContainer,c=(l.domNode,o._horizontalScrollBar),h=o._verticalScrollBar;s(o._currentTranslationX,o._currentTranslationY,t,a)<1?(o._setTranslation(t,a),n()):(e=o._setTranslation(t,a,1),o._contentAnimation=l.animate({transform:o._kineticTransform.translate(e.translationX,e.translationY),duration:Math.round(i),curve:r},n),o._horizontalScrollBarAnimation=c&&c.animate({transform:this._kineticTransform.translate(Math.max(0,Math.min(1,-e.translationX/(l._measuredWidth-o._measuredWidth)))*(this._measuredWidth-this._scrollBarWidth),0),duration:i,curve:r}),o._verticalScrollBarAnimation=h&&h.animate({transform:this._kineticTransform.translate(0,Math.max(0,Math.min(1,-e.translationY/(l._measuredHeight-o._measuredHeight)))*(this._measuredHeight-this._scrollBarHeight)),duration:i,curve:r}))},_setTranslation:function(t,a,i){function r(t){return h*(-1/(t/_+1)+1)}var n=this._contentContainer,e=this._minTranslationX,o=this._minTranslationY,l=this._horizontalElastic&&!this.disableBounce&&this._measuredWidth<n._measuredWidth,s=this._verticalElastic&&!this.disableBounce&&this._measuredHeight<n._measuredHeight,c=this._measuredWidth,d=this._measuredHeight,m=n._measuredWidth,u=n._measuredHeight;if(t>0?t=l?r(t):0:e>t&&(t=l?e-r(e-t):e),a>0?a=s?r(a):0:o>a&&(a=s?o-r(o-a):o),i||this._contentContainer.animate({transform:this._kineticTransform.translate(this._currentTranslationX=t,this._currentTranslationY=a)}),this._isScrollBarActive){var g=this._horizontalScrollBar,T=this._verticalScrollBar;g&&g.animate({transform:this._kineticTransform.translate(Math.max(0,Math.min(1,-t/(m-c)))*(this._measuredWidth-this._scrollBarWidth),0)}),T&&T.animate({transform:this._kineticTransform.translate(0,Math.max(0,Math.min(1,-a/(u-d)))*(this._measuredHeight-this._scrollBarHeight))})}return{translationX:t,translationY:a}},_cancelAnimations:function(){this._horizontalScrollBarAnimation&&this._horizontalScrollBarAnimation.cancel(),this._verticalScrollBarAnimation&&this._verticalScrollBarAnimation.cancel(),this._contentAnimation&&this._contentAnimation.cancel()},_createHorizontalScrollBar:function(){this._horizontalScrollBar||this._add(this._horizontalScrollBar=o.createView({zIndex:2147483647,backgroundColor:"#555",borderRadius:3,width:0,height:6,left:0,bottom:0,opacity:0}))},_createVerticalScrollBar:function(){this._verticalScrollBar||this._add(this._verticalScrollBar=o.createView({zIndex:2147483647,backgroundColor:"#555",borderRadius:3,width:6,height:0,right:0,top:0,opacity:0}))},_destroyHorizontalScrollBar:function(){this._horizontalScrollBarAnimation&&this._horizontalScrollBarAnimation.cancel(),this._remove(this._horizontalScrollBar)},_destroyVerticalScrollBar:function(){this._verticalScrollBarAnimation&&this._verticalScrollBarAnimation.cancel(),this._remove(this._verticalScrollBar)},_startScrollBars:function(t,a){if(this._horizontalScrollBar&&a.x<1&&a.x>0){var i=this._measuredWidth,r=this._scrollBarWidth=Math.round(Math.max(10,i*a.x)),n=this._horizontalScrollBar;n.opacity=.5,n.domNode.style.width=l(r),n.animate({transform:this._kineticTransform.translate(Math.max(0,Math.min(1,t.x))*(i-r),0)}),this._isScrollBarActive=1}if(this._verticalScrollBar&&a.y<1&&a.y>0){var e=this._measuredHeight,o=this._scrollBarHeight=Math.round(Math.max(10,e*a.y)),s=this._verticalScrollBar;s.opacity=.5,s.domNode.style.height=l(o),s.animate({transform:this._kineticTransform.translate(0,Math.max(0,Math.min(1,t.y))*(e-o))}),this._isScrollBarActive=1}},_endScrollBars:function(){function t(t){t&&t.animate({opacity:0,duration:500},function(){a._isScrollBarActive=!1})}if(this._isScrollBarActive){var a=this,i=a._horizontalScrollBar,r=a._verticalScrollBar;t(i),t(r)}},properties:{scrollingEnabled:!0}})});