define(["Ti/_/declare","Ti/_/UI/KineticScrollView","Ti/_/style","Ti/_/lang","Ti/UI/MobileWeb/TableViewSeparatorStyle","Ti/UI"],function(e,t,i,n,r,s){var o=i.set,c=require.is,a=n.isDef,h=.001,l=/^click|singletap|longpress$/;return e("Ti.UI.TableView",t,{constructor:function(){var e=s.createView({width:s.INHERIT,height:s.SIZE,left:0,top:0,layout:s._LAYOUT_CONSTRAINING_VERTICAL});this._initKineticScrollView(e,"vertical","vertical",1),e._add(this._header=s.createView({height:s.SIZE,width:s.INHERIT,layout:s._LAYOUT_CONSTRAINING_VERTICAL})),e._add(this._sections=s.createView({height:s.SIZE,width:s.INHERIT,layout:s._LAYOUT_CONSTRAINING_VERTICAL})),e._add(this._footer=s.createView({height:s.SIZE,width:s.INHERIT,layout:s._LAYOUT_CONSTRAINING_VERTICAL})),this.__values__.constants.sections=[],this.data=[]},_handleMouseWheel:function(){this._fireScrollEvent("scroll")},_handleDragStart:function(){this.fireEvent("dragstart")},_handleDrag:function(e){this._fireScrollEvent("scroll",e)},_handleDragEnd:function(e,t,i){var n=this;if(a(i)){var r=i*i/(1.724*h)*(0>i?-1:1),o=Math.abs(i)/h,c=Math.min(0,Math.max(n._minTranslationY,n._currentTranslationY+r));n.fireEvent("dragend",{decelerate:!0}),n._animateToPosition(n._currentTranslationX,c,o,s.ANIMATION_CURVE_EASE_OUT,function(){n._setTranslation(n._currentTranslationX,c),n._endScrollBars(),n._fireScrollEvent("scrollend",e)})}},_fireScrollEvent:function(e,t){for(var i,n=0,r=this._contentContainer,s=-this._currentTranslationY,o=this._sections,c=o._children,a=c.length,h=0;a>h;h+=2){var l=c[h],_=s-l._measuredTop,d=l._measuredHeight-_;if(_>0&&d>0)for(var u=l._rows._children,f=1;f<u.length;f+=2){var S=u[f],w=_-S._measuredTop,T=S._measuredHeight-w;w>0&&T>0&&(n++,!i&&(i=S))}}this.fireEvent(e,{contentOffset:{x:0,y:s},contentSize:{width:o._measuredWidth,height:o._measuredHeight},firstVisibleItem:i,size:{width:r._measuredWidth,height:r._measuredHeight},totalItemCount:this.data.length,visibleItemCount:n,x:t&&t.x,y:t&&t.y})},_defaultWidth:s.FILL,_defaultHeight:s.FILL,_getContentOffset:function(){return{x:-this._currentTranslationX,y:-this._currentTranslationY}},fireEvent:function(e,i){var n,r=0,s=0,o=this._sections._children,c=this._tableViewRowClicked,a=this._tableViewSectionClicked;if(l.test(e)){if(c&&a){for(;r<o.length;r+=2){if(n=o[r]._rows._children.indexOf(c),-1!==n){s+=Math.floor(n/2);break}s+=o[r].rowCount}i.row=i.rowData=c,i.index=s,i.section=a,i.searchMode=!1,t.prototype.fireEvent.apply(this,arguments),this._tableViewRowClicked=null,this._tableViewSectionClicked=null}}else t.prototype.fireEvent.apply(this,arguments)},_createSeparator:function(){var e=s.createView({height:1,width:s.INHERIT,backgroundColor:"white"});return o(e.domNode,"minWidth","100%"),e},_createDecorationLabel:function(e){return s.createLabel({text:e,backgroundColor:"darkGrey",color:"white",width:s.INHERIT,height:s.SIZE,left:0,font:{fontSize:22}})},_refreshSections:function(){for(var e=0;e<this._sections._children.length;e+=2)this._sections._children[e]._refreshRows();this._triggerLayout()},_calculateLocation:function(e){for(var t,i=0,n=0;n<this._sections._children.length;n+=2)if(t=this._sections._children[n],i+=t.rowCount,i>e)return{section:t,localIndex:t.rowCount-(i-e)};return e==i?{section:t,localIndex:t.rowCount}:void 0},_insertRow:function(e,t){var i=this._calculateLocation(t);i&&i.section.add(e,i.localIndex),this._publish(e),this._refreshSections()},_removeRow:function(e){var t=this._calculateLocation(e);t&&(this._unpublish(t.section._rows._children[2*t.localIndex+1]),t.section._removeAt(t.localIndex))},appendRow:function(e){this._currentSection||(this._sections._add(this._currentSection=s.createTableViewSection({_tableView:this})),this.sections.push(this._currentSection),this._sections._add(this._createSeparator()),this.data.push(this._currentSection)),this._currentSection.add(e),this._publish(e),this._refreshSections()},deleteRow:function(e){this._removeRow(e)},insertRowAfter:function(e,t){this._insertRow(t,e+1)},insertRowBefore:function(e,t){this._insertRow(t,e)},updateRow:function(e,t){this._removeRow(e),this._insertRow(t,e)},scrollToIndex:function(e){var t=this._calculateLocation(e);t&&this._setTranslation(0,-t.section._measuredTop-t.section._rows._children[2*t.localIndex+1]._measuredTop)},scrollToTop:function(e){this._setTranslation(0,-e)},_insertSection:function(e,t){!c(e,"Array")&&(e=[e]);for(var i=0,n=e.length;n>i;i++)a(e[i].declaredClass)&&"Ti.UI.TableViewSection"==e[i].declaredClass||(e[i]=s.createTableViewSection(e[i])),this._sections._insertAt(e[i],t+i),t===n?this.sections.push(e[i]):this.sections.splice(t,0,e[i]);this._refreshSections()},_removeSection:function(e){this._sections._remove(this.sections[e]),this.sections.splice(e,1)},appendSection:function(e){this._insertSection(e,this.sections.length)},deleteSection:function(e){e in this.sections&&(this._sections._remove(this.sections[e]),this.sections.splice(e,1))},insertSectionBefore:function(e,t){this._insertSection(t,e)},insertSectionAfter:function(e,t){this._insertSection(t,e+1)},updateSection:function(e,t){this._removeSection(e),this._insertSection(t,e)},constants:{sectionCount:function(){return this.sections.length},sections:void 0},properties:{data:{set:function(e){if(c(e,"Array")){var t,i=[];this._sections._removeAllChildren(),this.__values__.constants.sections=[],this._currentSection=void 0;for(t in e)(!a(e[t].declaredClass)||"Ti.UI.TableViewRow"!=e[t].declaredClass&&"Ti.UI.TableViewSection"!=e[t].declaredClass)&&(e[t]=s.createTableViewRow(e[t]));for(t=0;t<e.length;t++)"Ti.UI.TableViewRow"===e[t].declaredClass?(this._currentSection||(this.appendSection(this._currentSection=s.createTableViewSection({_tableView:this})),i.push(this._currentSection)),this._currentSection.add(e[t])):"Ti.UI.TableViewSection"===e[t].declaredClass&&(e[t]._tableView=this,this.appendSection(this._currentSection=e[t]),i.push(this._currentSection)),this._publish(e[t]);return this._refreshSections(),i}}},footerTitle:{set:function(e,t){return t!=e&&(this._footer._removeAllChildren(),this._footer._add(this._createDecorationLabel(e))),e}},footerView:{set:function(e,t){return t!=e&&(this._footer._removeAllChildren(),this._footer._add(e)),e}},headerTitle:{set:function(e,t){return t!=e&&(this._header._removeAllChildren(),this._header._add(this._createDecorationLabel(e)),this._header._add(this._createSeparator())),e}},headerView:{set:function(e,t){return t!=e&&(this._header._removeAllChildren(),this._header._add(e)),e}},maxRowHeight:{post:"_refreshSections"},minRowHeight:{post:"_refreshSections"},rowHeight:{post:"_refreshSections",value:"50px"},separatorColor:{post:"_refreshSections",value:"lightGrey"},separatorStyle:{post:"_refreshSections",value:r.SINGLE_LINE}}})});