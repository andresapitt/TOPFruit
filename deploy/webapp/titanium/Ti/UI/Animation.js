define(["Ti/_/declare","Ti/_/Evented","Ti/_/style","Ti/UI"],function(e,t,i,r){function o(){r._layoutInProgress?c.once(r,"postlayout",function(){requestAnimationFrame(n)}):requestAnimationFrame(n)}function n(){var e,t,i,r,n,a,s,f,c,v,m,p,h,b,x=l();u=0;for(e in M)for(t=M[e],n=0;n<t.length;n++)if(i=t[n],!i.paused){if(v=i.duration?Math.min(1,(x-i.ts)/i.duration):1,m=d[i.curve](i.forward?v:1-v),r=i.elem,r._isAttachedToActiveWin())for(p in i.props){if(b=i.props[p],f=b[0],c=b[1],1===v&&(h=i.forward?c:f),"transform"===p){if(1!==v){for(h=[],s=f.length,a=0;s>a;a++)(12>a||a>14)&&(h[a]=f[a]+(c[a]-f[a])*m);u=1}16===h.length?(a=h.splice(12),h="matrix3d("+h.join(",")+") rotate3d("+a.join(",")+"deg)"):(a=h.pop(),h="matrix("+h.join(",")+") rotate("+a+"deg)"),p=q}else if(g[p]){if(1!==v){for(h=[],a=0;4>a;a++)h[a]=Math.floor(f[a]+(c[a]-f[a])*m);u=1}h="rgba("+h.join(",")+")"}else w[p]&&(1!==v&&(h=f+(c-f)*m,u=1),h="opacity"===p?h:h+"px");i.prev!==h&&(r.domNode.style[p]=h),i.prev=h}1===v&&(i.ts=x,i.duration&&i.reverse&&i.forward?(i.forward=0,u=1):i.repeat-->0?u=i.forward=1:(t.splice(n--,1),i.promise.resolve(),t.length||M[e].activeCount||delete M[e]))}u&&o()}function a(e){var t,i,r,o;if(e=e.trim().toLowerCase(),"#"===e.charAt(0))i=4==e.length?4:8,isNaN(e=Number("0x"+e.substring(1)))||(r=(1<<i)-1,o=4===i?17:1,o=[(e>>2*i&r)*o,(e>>i&r)*o,(e&r)*o,1]);else if(t=e.match(b))for(o=t[1].split(/\s*,\s*/),t=0;3>t;)o[t++]|=0;else C&&(o=C[e]);return o?(o[3]=isNaN(t=parseFloat(o[3]))?1:Math.min(Math.max(t,0),1),o):void 0}function s(e,t,i,r){var o,n,a,s,u=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0];if(e)if(o=e[1],n=e[2].split(","),a=n.length,o&&16===a)for(s=0;12>s;s++)u[s]=n[s];else o||6!==a||(u[0]=n[0],u[1]=n[1],u[4]=n[2],u[5]=n[3],u[3]=n[4],u[7]=n[5]);if(t)if(o=t[1],n=t[2].split(","),a=n.length,o&&4===a)for(s=0;4>s;s++)u[12+s]=n[s];else o||1!==a||(u[14]=1,u[15]=n[0]);return i=2===r?[i.a,i.b,0,i.tx,i.c,i.d,0,i.ty,0,0,1,0,0,0,1,i.rotation]:[i.m11,i.m12,i.m13,i.m14,i.m21,i.m22,i.m23,i.m24,i.m31,i.m32,i.m33,i.m34,i.rotationX,i.rotationY,i.rotationZ,i.rotation],[u,i]}for(var u,d=[function(e){return e*=2,1>e?Math.pow(e,2)/2:-1*(--e*(e-2)-1)/2},function(e){return Math.pow(e,2)},function(e){return e*(e-2)*-1},function(e){return e}],f=window,l=Date.now,c=require.on,v=0,m=["ms","moz","webkit","o"],p=m.length,h={autoreverse:1,bottom:1,center:1,curve:1,delay:1,duration:1,repeat:1,right:1,visible:1,zIndex:1},g={backgroundColor:1,color:1},w={height:1,left:1,opacity:1,top:1,width:1},b=/^rgba?\(([\s\.,0-9]+)\)/,x=/3d/,y=/^Ti\.UI\.(2|3)DMatrix$/,A=/matrix(3d)?\(([^\)]*)/,_=/rotate(3d)?\(([^\)]*)/,M={},q=i.discover("transform"),C=require(require.config.ti.colorsModule),F=e("Ti.UI.Animation",t,{properties:{autoreverse:void 0,backgroundColor:void 0,bottom:void 0,center:void 0,color:void 0,curve:void 0,delay:void 0,duration:void 0,height:void 0,left:void 0,opacity:void 0,repeat:void 0,right:void 0,top:void 0,transform:void 0,visible:void 0,width:void 0,zIndex:void 0}});--p>=0&&!f.requestAnimationFrame;)f.requestAnimationFrame=f[m[p]+"RequestAnimationFrame"];return f.requestAnimationFrame||(f.requestAnimationFrame=function(e){var t=l(),i=Math.max(0,16-(t-v)),r=window.setTimeout(function(){e(t+i)},i);return v=t+i,r}),F._play=function(e,t){function r(){if(!e._alive||!e._isAttachedToActiveWin())return void m.activeCount--;var r,n,c,b,M,q,C,F,I,N,T={},E=e._parent._layout.calculateAnimation(e,t);for(c in p)if(q=p[c],!h[c]&&void 0!==q){for(r=0;r<m.length;r++)delete m[r].props[c],require.isEmpty(m[r].props)&&m.splice(r--,1);if(b=i.get(e.domNode,c),g[c])b=a(b),q=a(q),(q>b||b>q)&&(T[c]=[b,q]);else if(w[c])isNaN(b=parseFloat(b))&&"opacity"===c&&(b=1),q=c in E?E[c]:q,b!==q&&(T[c]=[b,q]);else if("transform"===c&&(M=q.declaredClass.match(y))){if(M=0|M[1],I=b.match(A),N=b.match(_),x.test(b)||3===M)C=s(I,N,q,M),b=C[0],q=C[1];else if(2===M){if(b=[1,0,0,1,0,0,0],I)for(F=I[2].split(","),n=Math.min(6,F.length),r=0;n>r;r++)b[r]=parseFloat(F[r]);N&&(F=N[2].split(","),F.length&&(b[6]=parseFloat(F[0]))),q=[q.a,q.b,q.c,q.d,q.tx,q.ty,q.rotation],C=[b,q]}(q>b||b>q)&&(T[c]=C)}}m.push({id:v,elem:e,promise:f,props:T,ts:l(),reverse:!!p.autoreverse,forward:1,curve:Math.max(0,Math.min(d.length-1,0|p.curve)),duration:0|p.duration,repeat:!!p.repeat}),t.fireEvent("start"),u||(u=1,o())}function n(){for(var e=0,t=m&&m.length;t>e;e++)if(m[e].id===v)return m[e]}var f=new require.Promise,c=e.widgetId,v=1e9*Math.random()|0,m=M[c]=M[c]||[],p=t.__values__.properties,b=0|p.delay,q=!!p.visible,C=p.zIndex;return m.activeCount=~~m.activeCount+1,setTimeout(r,b||0),f.source=e,f.animation=t,f.pause=function(){var e=n();return e=!!e&&(e.paused||(e.paused=l())),t.fireEvent("pause"),e},f.resume=function(){var e=n();return e&&(e.paused&&(e.ts+=l()-e.paused),u||(u=1,o())),e=!!e&&!(e.paused=0),t.fireEvent("resume"),e},f.cancel=function(e){for(var r,o,n,a=0,s=m&&m.length,u=!1;s>a;a++)if(m[a].id===v){if(r=m[a],e){n=r.elem.domNode;for(o in r.props)s=r.props[o][0],i.set(n,o,w[o]&&"opacity"!==o?s+"px":s)}m.splice(a,1),m.length||m.activeCount||delete M[c],u=!0;break}return m.activeCount--,t.fireEvent("cancel"),u},f.then(function(){void 0!==p.visible&&(e.visible=q),void 0!==p.zIndex&&(e.zIndex=C),m.activeCount--,t.fireEvent("complete")})},F});