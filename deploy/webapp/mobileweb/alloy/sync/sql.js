function S4(){return(0|65536*(1+Math.random())).toString(16).substring(1)}function guid(){return S4()+S4()+"-"+S4()+"-"+S4()+"-"+S4()+"-"+S4()+S4()+S4()}function Migrator(e,t){this.db=t,this.dbname=e.adapter.db_name,this.table=e.adapter.collection_name,this.idAttribute=e.adapter.idAttribute,this.column=function(e){var t=e.split(/\s+/),i=t[0];switch(i.toLowerCase()){case"string":case"varchar":case"date":case"datetime":Ti.API.warn('"'+i+'" is not a valid sqlite field, using TEXT instead');case"text":i="TEXT";break;case"int":case"tinyint":case"smallint":case"bigint":case"boolean":Ti.API.warn('"'+i+'" is not a valid sqlite field, using INTEGER instead');case"integer":i="INTEGER";break;case"double":case"float":case"decimal":case"number":Ti.API.warn('"'+e+'" is not a valid sqlite field, using REAL instead');case"real":i="REAL";break;case"blob":i="BLOB";break;case"null":i="NULL";break;default:i="TEXT"}return t[0]=i,t.join(" ")},this.createTable=function(e){var t=[],i=!1;for(var a in e.columns)a===this.idAttribute&&(i=!0),t.push(a+" "+this.column(e.columns[a]));i||this.idAttribute!==ALLOY_ID_DEFAULT||t.push(ALLOY_ID_DEFAULT+" TEXT UNIQUE");var n="CREATE TABLE IF NOT EXISTS "+this.table+" ( "+t.join(",")+")";this.db.execute(n)},this.dropTable=function(){this.db.execute("DROP TABLE IF EXISTS "+this.table)},this.insertRow=function(e){var t=[],i=[],a=[],n=!1;for(var r in e)r===this.idAttribute&&(n=!0),t.push(r),i.push(e[r]),a.push("?");n||this.idAttribute!==ALLOY_ID_DEFAULT||(t.push(this.idAttribute),i.push(guid()),a.push("?")),this.db.execute("INSERT INTO "+this.table+" ("+t.join(",")+") VALUES ("+a.join(",")+");",i)},this.deleteRow=function(e){var t="DELETE FROM "+this.table,i=_.keys(e),a=i.length,n=[],r=[];a&&(t+=" WHERE ");for(var o=0;a>o;o++)n.push(i[o]+" = ?"),r.push(e[i[o]]);t+=n.join(" AND "),this.db.execute(t,r)}}function Sync(e,t,i){var a,n,r=t.config.adapter.collection_name,o=t.config.columns,s=t.config.adapter.db_name||ALLOY_DB_DEFAULT,d=null;switch(e){case"create":case"update":d=function(){var e={};t.id||(t.id=t.idAttribute===ALLOY_ID_DEFAULT?guid():null,e[t.idAttribute]=t.id,t.set(e,{silent:!0}));var i=[],d=[],l=[];for(var c in o)i.push(c),d.push(t.get(c)),l.push("?");if(n="REPLACE INTO "+r+" ("+i.join(",")+") VALUES ("+l.join(",")+");",a=Ti.Database.open(s),a.execute("BEGIN;"),a.execute(n,d),null===t.id){var u="SELECT last_insert_rowid();",b=a.execute(u);b&&b.isValidRow()?(t.id=b.field(0),e[t.idAttribute]=t.id,t.set(e,{silent:!0})):Ti.API.warn("Unable to get ID from database for model: "+t.toJSON()),b&&b.close()}return a.execute("COMMIT;"),a.close(),t.toJSON()}();break;case"read":i.query&&i.id&&Ti.API.warn('Both "query" and "id" options were specified for model.fetch(). "id" will be ignored.'),n="SELECT * FROM "+r,i.query?n=i.query:i.id&&(n+=" WHERE "+t.idAttribute+" = "+i.id),a=Ti.Database.open(s);var l;l=_.isString(n)?a.execute(n):a.execute(n.statement,n.params);for(var c=0,u=[];l.isValidRow();){var b={},T=0;T=_.isFunction(l.fieldCount)?l.fieldCount():l.fieldCount,_.times(T,function(e){var t=l.fieldName(e);b[t]=l.fieldByName(t)}),u.push(b),c++,l.next()}l.close(),a.close(),t.length=c,d=1===c?u[0]:u;break;case"delete":n="DELETE FROM "+r+" WHERE "+t.idAttribute+"=?",a=Ti.Database.open(s),a.execute(n,t.id),a.close(),t.id=null,d=t.toJSON()}d?(_.isFunction(i.success)&&i.success(d),"read"!==e||i.silent||t.trigger("fetch",{fromAdapter:!0})):_.isFunction(i.error)&&i.error(d)}function GetMigrationFor(e,t){var i=null,a=Ti.Database.open(e);a.execute("CREATE TABLE IF NOT EXISTS migrations (latest TEXT, model TEXT);");var n=a.execute("SELECT latest FROM migrations where model = ?;",t);return n.isValidRow()&&(i=n.field(0)+""),n.close(),a.close(),i}function Migrate(e){var t=e.migrations||[],i={};t.length&&t[t.length-1](i);var a=e.prototype.config;a.adapter.db_name=a.adapter.db_name||ALLOY_DB_DEFAULT;var n=new Migrator(a),r="undefined"==typeof a.adapter.migration||null===a.adapter.migration?i.id:a.adapter.migration;if("undefined"==typeof r||null===r){var o=Ti.Database.open(a.adapter.db_name);return n.db=o,n.createTable(a),void o.close()}r+="";var s,d=GetMigrationFor(a.adapter.db_name,a.adapter.collection_name);if(d!==r){if(d&&d>r?(s=0,t.reverse()):s=1,db=Ti.Database.open(a.adapter.db_name),n.db=db,db.execute("BEGIN;"),t.length)for(var l=0;t.length>l;l++){var c=t[l],u={};if(c(u),s){if(u.id>r)break;if(d>=u.id)continue}else{if(r>=u.id)break;if(u.id>d)continue}var b=s?"up":"down";_.isFunction(u[b])&&u[b](n)}else n.createTable(a);db.execute("DELETE FROM migrations where model = ?",a.adapter.collection_name),db.execute("INSERT INTO migrations VALUES (?,?)",r,a.adapter.collection_name),db.execute("COMMIT;"),db.close(),n.db=null}}function installDatabase(e){var t=e.adapter.db_file,i=e.adapter.collection_name,a=/(^|.*\/)([^\/]+)\.[^\/]+$/,n=t.match(a);if(null===n)throw'Invalid sql database filename "'+t+'"';e.adapter.db_name=e.adapter.db_name||n[2];var r=e.adapter.db_name;Ti.API.debug('Installing sql database "'+t+'" with name "'+r+'"');for(var o=Ti.Database.install(t,r),s=o.execute('pragma table_info("'+i+'");'),d={};s.isValidRow();){var l=s.fieldByName("name"),c=s.fieldByName("type");d[l]=c,l!==ALLOY_ID_DEFAULT||e.adapter.idAttribute||(e.adapter.idAttribute=ALLOY_ID_DEFAULT),s.next()}if(e.columns=d,s.close(),e.adapter.idAttribute){if(!_.contains(_.keys(e.columns),e.adapter.idAttribute))throw'config.adapter.idAttribute "'+e.adapter.idAttribute+'" not found in list of columns for table "'+i+'"\ncolumns: ['+_.keys(e.columns).join(",")+"]"}else{Ti.API.info('No config.adapter.idAttribute specified for table "'+i+'"'),Ti.API.info('Adding "'+ALLOY_ID_DEFAULT+'" to uniquely identify rows');var u=[],b=[];_.each(e.columns,function(e,t){b.push(t),u.push(t+" "+e)});var T=b.join(",");o.execute("ALTER TABLE "+i+" RENAME TO "+i+"_temp;"),o.execute("CREATE TABLE "+i+"("+u.join(",")+","+ALLOY_ID_DEFAULT+" TEXT UNIQUE);"),o.execute("INSERT INTO "+i+"("+T+","+ALLOY_ID_DEFAULT+") SELECT "+T+",CAST(_ROWID_ AS TEXT) FROM "+i+"_temp;"),o.execute("DROP TABLE "+i+"_temp;"),e.columns[ALLOY_ID_DEFAULT]="TEXT UNIQUE",e.adapter.idAttribute=ALLOY_ID_DEFAULT}o.close()}var _=require("alloy/underscore")._,ALLOY_DB_DEFAULT="_alloy_",ALLOY_ID_DEFAULT="alloy_id",cache={config:{},Model:{}};module.exports.beforeModelCreate=function(e,t){if(cache.config[t])return cache.config[t];throw"No support for Titanium.Database in MobileWeb environment."},module.exports.afterModelCreate=function(e,t){return cache.Model[t]?cache.Model[t]:(e=e||{},e.prototype.idAttribute=e.prototype.config.adapter.idAttribute,Migrate(e),cache.Model[t]=e,e)},module.exports.sync=Sync;